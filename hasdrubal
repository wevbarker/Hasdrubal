#!/usr/bin/env bash
set -euo pipefail

# Hasdrubal tmux launcher (nested session approach)
# Creates a new tmux session with 3 panes:
#   - Top:    Hasdrubal REPL (interactive AI assistant)
#   - Middle: Watcher (monitors .PROMPT.txt and sends to REPL)
#   - Bottom: Vim editing .PROMPT.txt
#
# When the watcher exits, the entire session is cleaned up.
#
# Usage:
#   hasdrubal              # create session and attach
#   hasdrubal -p 70        # make the top (REPL) pane 70% height

# Resolve script directory
script_path="$(readlink -f -- "${BASH_SOURCE[0]}")"
script_dir="$(cd -- "$(dirname -- "$script_path")" && pwd)"

if [[ -z "${TMUX:-}" ]]; then
  echo "hasdrubal: not running inside tmux" >&2
  exit 1
fi

# Configuration
top_pct="${HASDRUBAL_TOP_PCT:-70}"
mid_lines="${HASDRUBAL_MID_LINES:-2}"

while [[ $# -gt 0 ]]; do
  case "$1" in
    -p|--percent)
      top_pct="$2"; shift 2;;
    --) shift; break;;
    -*) echo "hasdrubal: unknown option $1" >&2; exit 2;;
    *) echo "hasdrubal: this command takes only -p|--percent" >&2; exit 2;;
  esac
done

# Get current directory (where we'll work)
work_dir="$(tmux display-message -p -F '#{pane_current_path}')"
prompt_file="$work_dir/.PROMPT.txt"
log_file="$work_dir/.hasdrubal.log"
watcher_path="$script_dir/hasdrubal-watcher"

# Generate unique session name
session_name="hasdrubal-$$-$(date +%s)"

# Ensure files exist
cd "$work_dir"
: > "$prompt_file"
: > "$log_file"

printf '%s [hasdrubal] launcher: creating session=%s work_dir=%s\n' \
  "$(date '+%Y-%m-%d %H:%M:%S')" "$session_name" "$work_dir" >> "$log_file"

# Create new detached session with initial window
tmux new-session -d -s "$session_name" -c "$work_dir"

# Get the initial pane ID (will become vim pane)
vim_pane="$(tmux list-panes -t "$session_name" -F '#{pane_id}' | head -1)"

# Split to create top pane (REPL) - split horizontally, new pane above
tmux split-window -t "$session_name" -v -b -c "$work_dir" -p "$top_pct"
repl_pane="$(tmux list-panes -t "$session_name" -F '#{pane_id}' | head -1)"

# Split to create middle pane (watcher) - split bottom pane, new pane above it
tmux split-window -t "$vim_pane" -v -b -c "$work_dir" -l "$mid_lines"
watcher_pane="$(tmux list-panes -t "$session_name" -F '#{pane_id}' | sed -n '2p')"

# Start REPL in top pane
tmux send-keys -t "$repl_pane" "cd '$work_dir' && source venv/bin/activate && python AI/hasdrubal_repl.py" C-m

# Start watcher in middle pane with cleanup handler
tmux send-keys -t "$watcher_pane" \
  "HASDRUBAL_SESSION='$session_name' HASDRUBAL_REPL_PANE='$repl_pane' HASDRUBAL_VIM_PANE='$vim_pane' HASDRUBAL_PROMPT_FILE='$prompt_file' HASDRUBAL_LOG_FILE='$log_file' bash '$watcher_path'" C-m

# Start Vim in bottom pane (skip powerline to avoid venv conflicts)
tmux send-keys -t "$vim_pane" "vim --cmd \"let g:powerline_loaded=1\" .PROMPT.txt" C-m

# Focus bottom (vim) pane
tmux select-pane -t "$vim_pane"

# Log success
printf '%s [hasdrubal] session created: %s (REPL=%s, watcher=%s, vim=%s)\n' \
  "$(date '+%Y-%m-%d %H:%M:%S')" "$session_name" "$repl_pane" "$watcher_pane" "$vim_pane" >> "$log_file"

echo "hasdrubal: starting nested session '$session_name'"
echo "           Press Ctrl-C in watcher pane or run ':qa!' in vim to exit all panes"

# Switch into the new session
tmux switch-client -t "$session_name"
